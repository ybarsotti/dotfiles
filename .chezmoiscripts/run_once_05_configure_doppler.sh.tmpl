#!/bin/bash

{{ if .dopplerProjectJson -}}
set -eufo pipefail

echo "🔐 Setting up Doppler environment variables..."

# Create a doppler env file that can be sourced
mkdir -p {{ .chezmoi.homeDir }}/.config/doppler

cat > {{ .chezmoi.homeDir }}/.config/doppler/env.sh << 'EOF'
# Auto-generated by chezmoi - DO NOT EDIT
# Source this file to load Doppler secrets as environment variables

{{ range $key, $value := .dopplerProjectJson -}}
export {{ $key }}="{{ $value }}"
{{ end -}}
EOF

chmod 600 {{ .chezmoi.homeDir }}/.config/doppler/env.sh

echo "✅ Doppler environment file created at ~/.config/doppler/env.sh"
echo "   Add 'source ~/.config/doppler/env.sh' to your shell config to load secrets"
{{ end -}}
