#!/bin/bash

# run_once_09_setup_qmd_collections.sh
#
# Sets up qmd collections for the Obsidian knowledge base.
# qmd is a local search engine for markdown files used by humans and AI agents.

set -eufo pipefail

{{ template "homebrew_path_setup" . }}

export PATH="$HOME/.local/bin:$PATH"

if ! command -v qmd &>/dev/null; then
    echo "Warning: qmd not found. Skipping collection setup."
    echo "Install with: npm install -g @tobilu/qmd"
    exit 0
fi

VAULT="$HOME/Documents/Obsidian/BrainDump"

if [ ! -d "$VAULT" ]; then
    echo "Warning: Obsidian vault not found at $VAULT. Skipping qmd setup."
    exit 0
fi

echo "Setting up qmd collections..."

# --- Collection 1: technical-studies ---
# Deep technical learning content (database internals, architecture, DevOps)
echo "Adding collection: technical-studies"
if [ -d "$VAULT/20 Projects/Database study" ]; then
    qmd collection add "$VAULT/20 Projects/Database study" --name technical-studies-db --mask "*.md"
    qmd context add "$VAULT/20 Projects/Database study" "PostgreSQL internals study: heap pages, MVCC, indexing (B-Tree, BRIN, GIN), query optimization, WAL, locks, and performance tuning. Hands-on labs with SQL examples."
fi

if [ -d "$VAULT/15 Library/Courses" ]; then
    qmd collection add "$VAULT/15 Library/Courses" --name technical-studies-courses --mask "*.md"
    qmd context add "$VAULT/15 Library/Courses" "Software architecture courses: MBA modules covering DevOps, SRE, Cloud, microservices, SOLID patterns, CI/CD pipelines, observability, and infrastructure as code."
fi

# --- Collection 2: resources ---
# Knowledge base / zettelkasten with diverse topics
echo "Adding collection: resources"
if [ -d "$VAULT/40 Resources" ]; then
    qmd collection add "$VAULT/40 Resources" --name resources --mask "*.md"
    qmd context add "$VAULT/40 Resources" "Personal knowledge base organized by topic: AI/ML roadmaps and patterns, code snippets (React, Python), data engineering, database design, DevOps practices, security, and Rust."
    qmd context add "$VAULT/40 Resources/AI & ML" "AI and machine learning: LLM applications, prompt engineering, AI agents, design patterns for ML systems, professional development roadmap."
    qmd context add "$VAULT/40 Resources/Snippets" "Reusable code patterns and snippets: React Query, custom hooks, testing setup, Python patterns."
    qmd context add "$VAULT/40 Resources/Data Engineering" "Data engineering concepts, tools, and practices."
    qmd context add "$VAULT/40 Resources/Database" "Database design, open-source solutions, and system design patterns."
fi

# --- Collection 3: career ---
# Career development and product thinking
echo "Adding collection: career"
if [ -d "$VAULT/15 Library/Career" ]; then
    qmd collection add "$VAULT/15 Library/Career" --name career --mask "*.md"
    qmd context add "$VAULT/15 Library/Career" "Career development: interview preparation, management skills, professional growth strategies."
fi

if [ -d "$VAULT/50 Archive" ]; then
    qmd collection add "$VAULT/50 Archive" --name career-archive --mask "*.md"
    qmd context add "$VAULT/50 Archive" "Archived projects with product requirement documents (PRDs), architecture overviews, and feature documentation. Useful as templates and reference."
fi

# --- Global context ---
qmd context add "/" "Personal knowledge base in Portuguese (PT-BR) with technical English terms. If you see a relevant [[WikiWord]], you can search for that WikiWord to get more context."

# --- Build indexes ---
echo "Updating qmd index..."
qmd update

echo "Building vector embeddings (this may take a few minutes on first run)..."
qmd embed

echo "âœ… qmd collections setup complete!"
qmd status
