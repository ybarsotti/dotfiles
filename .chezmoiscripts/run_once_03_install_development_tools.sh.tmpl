#!/bin/bash

# run_once_after_02_install-apps-and-extensions.sh
#
# This script installs applications and extensions for already-installed tools.

set -eufo pipefail

# Ensure PATHs are sourced to find newly installed commands
export PATH="$HOME/.cargo/bin:$HOME/.local/bin:$PATH"

{{ template "homebrew_path_setup" . }}

# --- Create Developer directory structure ---
echo "Setting up development directory structure..."

# Create main Developer directory and subdirectories
DEVELOPER_DIRS=(
    "$HOME/Developer"
    "$HOME/Developer/Personal"
    "$HOME/Developer/Work"
    "$HOME/Developer/Experiments"
    "$HOME/Developer/Open-Source" 
    "$HOME/Developer/Archive"
    "$HOME/Developer/Tools"
)

for dir in "${DEVELOPER_DIRS[@]}"; do
    if [ ! -d "$dir" ]; then
        mkdir -p "$dir"
        echo "✅ Created $(basename "$dir") directory"
    else
        echo "✅ $(basename "$dir") directory already exists"
    fi
done

echo "📁 Developer directory structure complete:"
echo "   ~/Developer/Personal    - Personal projects and side projects"
echo "   ~/Developer/Work        - Work-related projects"
echo "   ~/Developer/Experiments - Learning, tutorials, proof-of-concepts"
echo "   ~/Developer/Open-Source - Open source contributions"
echo "   ~/Developer/Archive     - Completed or archived projects"
echo "   ~/Developer/Tools       - Custom scripts and development tools"

# --- Install Cargo packages (Rust) ---
echo "Installing Cargo packages..."
if ! command -v selene &>/dev/null; then
  cargo install selene
else
  echo "selene is already installed."
fi

# --- Install global Python packages using pipx ---
echo "Installing global Python packages with pipx..."
if command -v pipx &>/dev/null; then
    pipx_packages=(
        "invoke"
        "pynvim"
    )
    
    for pkg in "${pipx_packages[@]}"; do
        if pipx list | grep -q "$pkg"; then
            echo "pipx package $pkg is already installed."
        else
            echo "Installing pipx package $pkg..."
            pipx install "$pkg"
        fi
    done
else
    echo "Warning: pipx not found. Skipping Python package installation."
    echo "Note: pipx should be installed via Homebrew in the packages script."
fi

# --- Install gh extensions ---
echo "Installing gh extensions..."

# Check if gh is available, if not try to install it
if ! command -v gh &>/dev/null; then
    echo "GitHub CLI (gh) not found. Attempting to install..."
    if command -v brew &>/dev/null; then
        brew install gh
    else
        echo "Error: Neither gh nor brew found. Cannot install GitHub CLI."
        echo "Please ensure Homebrew packages are installed first."
        exit 1
    fi
fi

# Verify gh is now available
if ! command -v gh &>/dev/null; then
    echo "Error: Failed to install or find GitHub CLI (gh)."
    echo "Please install it manually: brew install gh"
    exit 1
fi

# Check if gh is authenticated
if ! gh auth status &>/dev/null; then
    echo "GitHub CLI is not authenticated. Please login..."
    echo "This will open your browser for authentication."
    read -p "Press Enter to continue with 'gh auth login'..."
    gh auth login
    
    # Verify authentication was successful
    if ! gh auth status &>/dev/null; then
        echo "Error: GitHub CLI authentication failed."
        echo "Please run 'gh auth login' manually and try again."
        exit 1
    fi
    echo "✅ GitHub CLI authentication successful!"
else
    echo "✅ GitHub CLI is already authenticated."
fi

gh_extensions=(
  "mislav/gh-branch"
  "johnmanjiro13/gh-bump"
  "davidraviv/gh-clean-branches"
  "matt-bartel/gh-clone-org"
  "dlvhdr/gh-dash"
  "yuler/gh-download"
  "jrnxf/gh-eco"
  "redraw/gh-install"
  "valeriobelli/gh-milestone"
  "meiji163/gh-notify"
  "seachicken/gh-poi"
  "mona-actions/gh-repo-stats"
  "github/gh-skyline"
  "gpmtools/gh-task"
  "jake-low/gh-log"
)

installed_extensions=$(gh extension list | awk '{print $1}')

for ext in "${gh_extensions[@]}"; do
  if echo "$installed_extensions" | grep -q "$ext"; then
    echo "gh extension $ext is already installed."
  else
    echo "Installing gh extension $ext..."
    gh extension install "$ext"
  fi
done

# --- Install Global NPM Packages ---
echo "Installing global NPM packages..."

# Ensure mise is on the PATH and setup a global node version
# This makes 'npm' available for the next steps.
# Using 'lts' is a safe default.
if command -v mise &>/dev/null; then
    echo "Setting up Node.js via mise..."
    mise use --global node@lts
else
    echo "Warning: mise command not found. Cannot set up Node.js to install NPM packages."
fi

# Check if 'npm' is available before proceeding
if command -v npm &>/dev/null; then
    # Package list
    npm_packages=(
        "@anthropic-ai/claude-code"
        "neovim"
        # "typescript"
        # "vercel"
    )

    # Get list of globally installed packages
    installed_npm_packages=$(npm list -g --depth=0)

    for pkg in "${npm_packages[@]}"; do
        if echo "$installed_npm_packages" | grep -q "$pkg"; then
            echo "NPM package $pkg is already installed."
        else
            echo "Installing NPM package $pkg..."
            npm install -g "$pkg"
        fi
    done
else
    echo "Warning: npm command not found. Skipping global NPM package installation."
fi

echo "Application and extension installation complete."
