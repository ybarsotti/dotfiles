#!/bin/bash

# run_once_after_02_install-apps-and-extensions.sh
#
# This script installs applications and extensions for already-installed tools.

set -eufo pipefail

# Ensure PATHs are sourced to find newly installed commands
export PATH="$HOME/.cargo/bin:$HOME/.local/bin:$PATH"

{{ template "homebrew_path_setup" . }}

# --- Create Developer directory structure ---
echo "Setting up development directory structure..."

# Machine-specific settings
MACHINE_PURPOSE="{{ .machine.purpose }}"

# Create main Developer directory
if [ ! -d "$HOME/Developer" ]; then
    mkdir -p "$HOME/Developer"
    echo "âœ… Created Developer directory"
else
    echo "âœ… Developer directory already exists"
fi

# Create subdirectories based on machine purpose
if [ "$MACHINE_PURPOSE" = "work" ]; then
    # Work machine: only create Work directory
    DEVELOPER_DIRS=(
        "$HOME/Developer/Work"
    )
    echo "ðŸ¢ Work machine detected - creating work-focused directory structure"
else
    # Personal machine: create full structure
    DEVELOPER_DIRS=(
        "$HOME/Developer/Personal"
        "$HOME/Developer/Work"
        "$HOME/Developer/Learning"
        "$HOME/Developer/Learning/Courses"
        "$HOME/Developer/Learning/Tutorials"
        "$HOME/Developer/Learning/Experiments"
        "$HOME/Developer/Open-Source" 
        "$HOME/Developer/Archive"
        "$HOME/Developer/Tools"
    )
    echo "ðŸ  Personal machine detected - creating full directory structure"
fi

for dir in "${DEVELOPER_DIRS[@]}"; do
    if [ ! -d "$dir" ]; then
        mkdir -p "$dir"
        echo "âœ… Created $(basename "$dir") directory"
    else
        echo "âœ… $(basename "$dir") directory already exists"
    fi
done

echo "ðŸ“ Developer directory structure complete:"
if [ "$MACHINE_PURPOSE" = "work" ]; then
    echo "   ~/Developer/Work        - Work-related projects"
else
    echo "   ~/Developer/Personal         - Personal projects and side projects"
    echo "   ~/Developer/Work             - Work-related projects"
    echo "   ~/Developer/Learning/        - Educational and study projects"
    echo "     â”œâ”€â”€ Courses/               - Online courses, bootcamps, structured learning"
    echo "     â”œâ”€â”€ Tutorials/             - Follow-along tutorials and guides"
    echo "     â””â”€â”€ Experiments/           - Code experiments and proof-of-concepts"
    echo "   ~/Developer/Open-Source      - Open source contributions"
    echo "   ~/Developer/Archive          - Completed or archived projects"
    echo "   ~/Developer/Tools            - Custom scripts and development tools"
fi

# --- Install Cargo packages (Rust) ---
echo "Installing Cargo packages..."
if ! command -v selene &>/dev/null; then
  cargo install selene
else
  echo "selene is already installed."
fi

# --- Install global Python packages using pipx ---
echo "Installing global Python packages with pipx..."
if command -v pipx &>/dev/null; then
    pipx_packages=(
        "invoke"
        "pynvim"
    )
    
    for pkg in "${pipx_packages[@]}"; do
        if pipx list | grep -q "$pkg"; then
            echo "pipx package $pkg is already installed."
        else
            echo "Installing pipx package $pkg..."
            pipx install "$pkg"
        fi
    done
else
    echo "Warning: pipx not found. Skipping Python package installation."
    echo "Note: pipx should be installed via Homebrew in the packages script."
fi

# --- Install gh extensions ---
echo "Installing gh extensions..."

# Check if gh is available, if not try to install it
if ! command -v gh &>/dev/null; then
    echo "GitHub CLI (gh) not found. Attempting to install..."
    if command -v brew &>/dev/null; then
        brew install gh
    else
        echo "Error: Neither gh nor brew found. Cannot install GitHub CLI."
        echo "Please ensure Homebrew packages are installed first."
        exit 1
    fi
fi

# Verify gh is now available
if ! command -v gh &>/dev/null; then
    echo "Error: Failed to install or find GitHub CLI (gh)."
    echo "Please install it manually: brew install gh"
    exit 1
fi

# Check if gh is authenticated
if ! gh auth status &>/dev/null; then
    echo "GitHub CLI is not authenticated. Please login..."
    echo "This will open your browser for authentication."
    read -p "Press Enter to continue with 'gh auth login'..."
    gh auth login
    
    # Verify authentication was successful
    if ! gh auth status &>/dev/null; then
        echo "Error: GitHub CLI authentication failed."
        echo "Please run 'gh auth login' manually and try again."
        exit 1
    fi
    echo "âœ… GitHub CLI authentication successful!"
else
    echo "âœ… GitHub CLI is already authenticated."
fi

gh_extensions=(
  "mislav/gh-branch"
  "johnmanjiro13/gh-bump"
  "davidraviv/gh-clean-branches"
  "matt-bartel/gh-clone-org"
  "dlvhdr/gh-dash"
  "yuler/gh-download"
  "jrnxf/gh-eco"
  "redraw/gh-install"
  "valeriobelli/gh-milestone"
  "meiji163/gh-notify"
  "seachicken/gh-poi"
  "mona-actions/gh-repo-stats"
  "github/gh-skyline"
  "gpmtools/gh-task"
  "jake-low/gh-log"
  "github/gh-copilot"
)

installed_extensions=$(gh extension list | awk '{print $1}')

for ext in "${gh_extensions[@]}"; do
  if echo "$installed_extensions" | grep -q "$ext"; then
    echo "gh extension $ext is already installed."
  else
    echo "Installing gh extension $ext..."
    gh extension install "$ext"
  fi
done

# --- Install Global NPM Packages ---
echo "Installing global NPM packages..."

# Ensure mise is on the PATH and setup a global node version
# This makes 'npm' available for the next steps.
# Using 'lts' is a safe default.
if command -v mise &>/dev/null; then
    echo "Setting up Node.js via mise..."
    mise use --global node@lts
else
    echo "Warning: mise command not found. Cannot set up Node.js to install NPM packages."
fi

# Check if 'npm' is available before proceeding
if command -v npm &>/dev/null; then
    # Package list
    npm_packages=(
        "@anthropic-ai/claude-code"
        "@fission-ai/openspec"
        "neovim"
        # "typescript"
        # "vercel"
    )

    # Get list of globally installed packages
    installed_npm_packages=$(npm list -g --depth=0)

    for pkg in "${npm_packages[@]}"; do
        if echo "$installed_npm_packages" | grep -q "$pkg"; then
            echo "NPM package $pkg is already installed."
        else
            echo "Installing NPM package $pkg..."
            npm install -g "$pkg"
        fi
    done
else
    echo "Warning: npm command not found. Skipping global NPM package installation."
fi

# --- Install act (run GitHub Actions locally) ---
echo "Installing act..."
if ! command -v act &>/dev/null; then
    echo "act not found. Installing..."
    curl --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash
    echo "âœ… act installed successfully."
else
    echo "âœ… act is already installed."
fi

# --- Install Cursor CLI ---
echo "Installing Cursor CLI..."
if ! command -v cursor &>/dev/null; then
    echo "Cursor CLI not found. Installing..."
    curl https://cursor.com/install -fsS | bash
    echo "âœ… Cursor CLI installed successfully."
else
    echo "âœ… Cursor CLI is already installed."
fi

echo "Application and extension installation complete."
