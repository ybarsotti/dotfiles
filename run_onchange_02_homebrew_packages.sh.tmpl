{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash

set -eufo pipefail

# Ensure brew is available before running
if ! command -v brew &>/dev/null; then
    echo "Homebrew not found, skipping package installation"
    exit 0
fi

# Check macOS version for borders compatibility
MACOS_VERSION=$(sw_vers -productVersion | cut -d. -f1)

brew bundle --file=/dev/stdin <<EOF
{{/* Iterate through all brew categories and subcategories */}}
{{- range $category, $items := .packages.darwin.brews }}
{{-   if kindIs "slice" $items }}
{{-     range $items }}
{{-       if eq . "borders" }}
# borders requires macOS 14+ - install conditionally
{{-       else }}
brew {{ . | quote }}
{{-       end }}
{{-     end }}
{{-   else }}
{{-     range $subcategory, $subitems := $items }}
{{-       if kindIs "slice" $subitems }}
{{-         range $subitems }}
{{-           if eq . "borders" }}
# borders requires macOS 14+ - install conditionally
{{-           else }}
brew {{ . | quote }}
{{-           end }}
{{-         end }}
{{-       end }}
{{-     end }}
{{-   end }}
{{- end }}

{{/* Iterate through all cask categories and subcategories */}}
{{- range $category, $items := .packages.darwin.casks }}
{{-   if kindIs "slice" $items }}
{{-     range $items }}
cask {{ . | quote }}
{{-     end }}
{{-   else }}
{{-     range $subcategory, $subitems := $items }}
{{-       if kindIs "slice" $subitems }}
{{-         range $subitems }}
cask {{ . | quote }}
{{-         end }}
{{-       end }}
{{-     end }}
{{-   end }}
{{- end }}
{{ if eq .machine.purpose "personal" }}
{{/* Personal-only brew packages */}}
{{- range $category, $items := .packages.darwin.personal_brews }}
{{-   if kindIs "slice" $items }}
{{-     range $items }}
brew {{ . | quote }}
{{-     end }}
{{-   else }}
{{-     range $subcategory, $subitems := $items }}
{{-       if kindIs "slice" $subitems }}
{{-         range $subitems }}
brew {{ . | quote }}
{{-         end }}
{{-       end }}
{{-     end }}
{{-   end }}
{{- end }}
{{ end }}
EOF

# Install borders separately with version check
if [[ $MACOS_VERSION -ge 14 ]]; then
    echo "Installing borders (requires macOS 14+)..."
    brew install borders
else
    echo "Skipping borders - requires macOS 14+ (current: $(sw_vers -productVersion))"
fi
{{ end -}}
